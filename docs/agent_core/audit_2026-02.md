# AgentCore audit — 2026-02 (final polish before app work)

Date: 2026-02-15

This document records the last audit & polish pass on AgentCore (gem + app
contrib) before starting the Rails Chat UI work.

## Goals

- Fix known Contrib failures and remove API footguns.
- Make pause → resume flows ergonomic at the **top level** (Agent / AgentSession).
- Reduce app glue by improving tools registry wiring (skills + MCP naming).
- Align docs with the current implementation (remove design-phase drift).

## Fixes

### Contrib language policy rewrite (real bug)

- Fixed `AgentCore::Contrib::AgentSession#apply_language_policy_to_run_result`
  to rebuild `PromptRunner::RunResult` with required keywords (`run_id`,
  `started_at`, `ended_at`, `duration_ms`) and preserve trace + continuation.
- Rewrite is **final-only** and is skipped when the run is paused:
  - `awaiting_tool_confirmation?`
  - `awaiting_tool_results?`
- When rewrite happens, session history is kept consistent when possible.

### ChatHistory consistency helper (gem)

- Added `AgentCore::Resources::ChatHistory::InMemory#replace_message(target, replacement)`
  for identity-based replacement (thread-safe).
- Contrib uses this opportunistically (only when the history implementation
  supports it).

## Ergonomics improvements

### Top-level resume APIs (gem)

Added to `AgentCore::Agent`:

- `#resume` / `#resume_stream`
- `#resume_with_tool_results` / `#resume_stream_with_tool_results`

These accept `continuation:` as either:

- `PromptRunner::Continuation`, or
- `PromptRunner::RunResult` (uses `run_result.continuation`)

### Tools registry: one-liner wiring (gem)

- Added `Resources::Tools::Registry#register_skills_store(...)` which builds
  `skills.list/load/read_file` tools via `Resources::Skills::Tools.build(...)`.
- Enhanced `Registry#register_mcp_client`:
  - new `server_id:` keyword
  - tool names use `AgentCore::MCP::ToolAdapter.local_tool_name(...)` when
    `server_id:` is provided
  - `server_id:` takes priority over `prefix:` (warn once when both given)

### AgentSession: pause/resume + ToolExecutor injection (app contrib)

`AgentCore::Contrib::AgentSession` now:

- accepts `tool_executor:` and wires it into the underlying Agent
- exposes:
  - `#resume` / `#resume_stream`
  - `#resume_with_tool_results` / `#resume_stream_with_tool_results`

When language policy is enabled, all `*_stream` methods follow the existing
final-only streaming strategy (buffer + emit rewritten final text).

## References & inspiration

Borrowed/confirmed ideas:

- **Stateful pause/resume** as a first-class user experience (pi-mono style).
- **Registry as the integration point** (minimize app-side glue; everything is a
  tool or built from tools).
- **Safe MCP naming** for multi-server usage (stable local names + sanitization).

## Deferred (explicitly not built in this pass)

- Cancellation/abort semantics across a run (and persisted continuations).
- Automatic context compaction / summarization strategies.
- Persistence format guarantees for `Continuation` (apps own serialization).
- Advanced prompt templating pipelines (SillyTavern-style assembly).

## Verification commands

- Gem: `cd vendor/agent_core && bundle exec rake`
- Rails contrib subset: `bin/rails test test/lib/agent_core/contrib`
- Optional macro check: `bin/ci`
